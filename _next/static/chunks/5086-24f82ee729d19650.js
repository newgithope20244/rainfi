(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5086],{87853:function(e,t,a){"use strict";a.r(t),a.d(t,{AssetsProvider:function(){return AssetsProvider}});var n=a(97997),o=a(44718),i=a(11720),s=a(81680),l=a(56935),r=a(9669),u=a.n(r),d=a(29043),c=a(26630),p=a(56432),f=a(306),g=a(73278),y=a(12012),m=a(29750),w=a(14330);let A=(0,i.createContext)({assetsInWallet:[],mortgagesOpen:[],totalCollateralUsd:0,loanRequestBorrower:[],totalLoans:{userActives:0,userHistory:0,poolActives:0,poolHistory:0},loanRequestPool:[],poolAvailable:[],poolsNames:{},blacklistedFrom:0,lookupTables:{pools:{},amount:0},supportedCurrencies:{},userStats:null,poolRefreshing:!1,myLoans:[],poolsMetadata:{},myPool:null,collectionStats:[],collections:[],isExpireSoon:[],isRefreshing:!1,hasBadgers:!1,refresh:()=>null}),AssetsProvider=e=>{let{children:t}=e,{publicKey:r}=(0,m.yG)(),{connection:S}=(0,o.R)(),{rpcToken:b,supportedCurrencies:v}=(0,i.useContext)(p.default),[P,h]=(0,i.useState)(null),[R,T]=(0,i.useState)(void 0),[N,x]=(0,i.useState)(!1),[k,C]=(0,i.useState)(null),[I,B]=(0,i.useState)(null),[E,L]=(0,i.useState)(null),[K,M]=(0,i.useState)(null),[q,F]=(0,i.useState)(null),[G,U]=(0,i.useState)(null),[W,D]=(0,i.useState)({userActives:0,userHistory:0,poolActives:0,poolHistory:0}),[_,V]=(0,i.useState)({}),[H,O]=(0,i.useState)(null),[z,Y]=(0,i.useState)(0),[Z,j]=(0,i.useState)(null),[J,Q]=(0,i.useState)(null),[X,$]=(0,i.useState)(0),[ee,et]=(0,i.useState)(!1),[ea,en]=(0,i.useState)(!0),[eo]=(0,i.useState)(!1),[ei,es]=(0,i.useState)([]),[el,er]=(0,i.useState)(null),[eu,ed]=(0,i.useState)([]),ec=(0,d.ZP)(),refresh=async e=>{var t,a,n,o,i,d;switch(et(!0),e){case"assets":if(!r){et(!1);return}let[c,p,g]=await Promise.all([u().get("https://api.rain.fi/user/".concat(null==r?void 0:r.toBase58(),"/items")),(0,l.Fl)(el,null==r?void 0:r.toBase58()),(0,y.e0)(r)]);(null==p?void 0:p.length)&&(null===(a=c.data)||void 0===a||null===(t=a.items)||void 0===t||t.push(...p));let m=await (0,f.Vh)(c.data,r.toBase58(),g,q);h(m),et(!1);break;case"user-stats":let A=await (0,y.Tu)(r);Y(A.totalCollateralUsd),O(A.user),et(!1);break;case"pool":let b=await (0,y.$V)(),P=b.reduce((e,t)=>({...e,[t.owner]:{thumbnail:t.thumbnail,name:t.name}}),{});V(P),Q(b);let N=b.reduce((e,t)=>(e[t.poolAddress]=t.name,e),{});C(N),et(!1),r||en(!1);break;case"pool-loan-request":let x=R?await ec.getCustomLoanOffersFromLender(S,r):null,k=[...x.loans||[],...x.mortgages||[]];M(k),et(!1);break;case"address-loan-request":if(!r){et(!1);return}let I=await ec.getCustomLoanOffersFromBorrower(S,r);L([...I.loans||[],...I.mortgages||[]]),et(!1);break;case"loans":if(!r){et(!1);return}let[B,E]=await Promise.all([(0,y.mx)(r),(0,y.jy)(r)]);D({userHistory:E.totalCount,userActives:E.ongoingCount,poolActives:B.ongoingCount,poolHistory:B.totalCount});let K=null===(n=B.loans)||void 0===n?void 0:n.filter(e=>"loan"==e.kind),G=null===(o=E.loans)||void 0===o?void 0:o.filter(e=>"loan"==e.kind),W=null===(i=B.loans)||void 0===i?void 0:i.filter(e=>"mortgage"==e.kind),_=null===(d=E.loans)||void 0===d?void 0:d.filter(e=>"mortgage"==e.kind);U([...G,...K]),j([...W||[],..._||[]]),et(!1);break;case"mypool":if(!r){et(!1);return}let[H,z]=await Promise.all([(0,y.vB)(r),S.getBalance((0,w.findPoolPda)(r),"processed")]);T(null),z&&T(H),et(!1);break;case"stats":let Z=await (0,s.F7)(),J=(0,s.dI)(await (0,y.Lg)(),Z,v);ed(Z),F(J.sort((e,t)=>e.collectionId>t.collectionId?1:e.collectionId<t.collectionId?-1:0)),et(!1)}},ep=(0,i.useCallback)(async()=>{if(N&&!r){T(null);return}et(!0),en(!0);let e=N?el:await (0,g.wF)("https://api.rain.fi/cnft");er(e);let t=[N&&J?Promise.resolve(J):(0,y.$V)(),(0,y.Lg)(),N&&eu?Promise.resolve(eu):(0,s.F7)()];r&&t.push((0,y.mx)(r),(0,y.jy)(r),(0,y.Tu)(r),Promise.resolve([]),Promise.resolve([]),(0,y.e0)(r),(0,y.vB)(r),S.getBalance((0,w.findPoolPda)(r),"processed"));let a=await Promise.all(t),n=a[0],o=a[1],d=a[2],{metadata:p,names:m}=n.reduce((e,t)=>(e.metadata[t.owner]={thumbnail:t.thumbnail,name:t.name},e.names[t.poolAddress]=t.name,e),{metadata:{},names:{}});V(p),C(m),Q(n),ed(d);let A=(0,s.dI)(o,d,v);if(F(A.sort((e,t)=>e.collectionId>t.collectionId?1:e.collectionId<t.collectionId?-1:0)),!r){x(!0),et(!1),en(!1),T(null),O(null);return}let b=a[3],P=a[4],R=[...null==b?void 0:b.loans,...null==P?void 0:P.loans],k=a[5],I=a[8],B=Promise.all([u().get("https://api.rain.fi/user/".concat(null==r?void 0:r.toBase58(),"/items")),(0,l.Fl)(e,null==r?void 0:r.toBase58())]);D({poolActives:b.ongoingCount,poolHistory:b.totalCount+b.ongoingCount,userHistory:P.totalCount,userActives:P.ongoingCount});try{let e=a[9],t=a[10];if(k){var E;$(null===(E=n.filter(e=>!(0,c.De)(k,e)))||void 0===E?void 0:E.length),O(k.user),Y(k.totalCollateralUsd)}let o=R.filter(e=>"loan"==e.kind),s=R.filter(e=>"mortgage"==e.kind);fetchRequests(),B.then(async e=>{var t,a;let n=e[0],o=e[1];(null==o?void 0:o.length)&&(null===(a=n.data)||void 0===a||null===(t=a.items)||void 0===t||t.push(...o));let i=await (0,f.Vh)(n.data,r.toBase58(),null!=I?I:[],A);h(i)}),(0,i.unstable_batchedUpdates)(()=>{es((0,c.Qn)(P.loans,r.toBase58())),U(o),t&&T(e||null),j(s),et(!1)})}catch(e){console.error("An error occurred while fetching data:",e)}},[N,r,J,q,eu,el,v]);async function fetchRequests(){let[e,t]=await Promise.all([ec.getCustomLoanOffersFromLender(S,r),ec.getCustomLoanOffersFromBorrower(S,r)]),a=[...e.loans||[],...e.mortgages||[]],n=[...(null==t?void 0:t.loans)||[],...(null==t?void 0:t.mortgages)||[]];L(a),M(n)}async function fetchAndAssignLookupTables(){let e={};var t=0;await Promise.all(J.map(async n=>{if("11111111111111111111111111111111"!=n.whitelist){let s=(await Promise.resolve().then(a.bind(a,59917))).PublicKey,l=(await S.getAddressLookupTable(new s(null==n?void 0:n.whitelist))).value;if(l){var o,i;e[n.owner]=null===(i=l.state)||void 0===i?void 0:null===(o=i.addresses)||void 0===o?void 0:o.map(e=>e.toBase58()),t=1}}})),B({pools:e,amount:t})}return(0,i.useEffect)(()=>{b&&v&&ep(),r||(h(null),O(null))},[r,b,v]),(0,i.useEffect)(()=>{r&&J&&!I&&fetchAndAssignLookupTables()},[r,J,I]),(0,n.tZ)(A.Provider,{value:{assetsInWallet:P,supportedCurrencies:v,userStats:H,totalCollateralUsd:z,poolsMetadata:_,blacklistedFrom:X,lookupTables:I,mortgagesOpen:Z,poolAvailable:J,poolsNames:k,poolRefreshing:ea,hasBadgers:eo,isExpireSoon:ei,loanRequestBorrower:E,loanRequestPool:K,totalLoans:W,myLoans:G,myPool:R,collectionStats:q,collections:eu,isRefreshing:ee,refresh},children:t})};A.displayName="AssetsContext",AssetsProvider.displayName="AssetsProvider",t.default=A},306:function(e,t,a){"use strict";a.d(t,{Vh:function(){return getAssets},ld:function(){return getBalances}});var n=a(56935),o=a(59917),i=a(14330);async function getAssets(e,t,a,o){let i=(0,n.D8)(null==e?void 0:e.items,o);return i&&(i=findLockedNfts(i,a)),i}let findLockedNfts=(e,t)=>e.map(e=>(e.locked=t.findIndex(t=>t.mint===e.mint)>-1,e)),getBalances=async(e,t)=>(await Promise.all(t.map(async t=>{let a=await e.getBalance((0,i.findLoanAuthorityPda)(new o.PublicKey(t.accountAddress)));return a>2445520?{address:t.accountAddress,balance:a}:{address:t.accountAddress,balance:0}}))).filter(e=>e.balance>0)},29043:function(e,t,a){"use strict";a.d(t,{ZP:function(){return useRain_hook}});var n=a(44718),o=a(59917),i=a(72174),s=a(29142),l=a(11720),r=a(87853),u=a(56432),d=a(36170),c=a(9669),p=a.n(c),f=a(56935),g=a(95827),y=a(14330),m=a(26630),w=a(30167),A=a(48764).Buffer;let S=new o.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),b=new o.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"),v=new o.PublicKey("39fEpihLATXPJCQuSiXLUSiCbGchGYjeL39eyXh3KbyT"),P=new o.PublicKey("CJsLwbP1iu5DuUikHEJnLfANgKy6stB2uFgvBBHoyxwz"),h=new o.PublicKey("auth9SigNpDKz4sJJ1DfCTuZrZNSAgh9sFD3rboVmgg");async function listV1(e,t,n,i,s,l,r){var u;let{BN:d}=await Promise.all([a.e(4527),a.e(3177),a.e(7459)]).then(a.t.bind(a,53177,23)),c=new o.PublicKey(n),p=(await e.getTokenSupply(c)).value.uiAmount,R=p&&p>1,T=new o.Account,N=R?(await (0,f.w2)(c,t))[0]:(await e.getTokenLargestAccounts(c)).value[0].address,x=(await o.PublicKey.findProgramAddress([R?T.publicKey.toBuffer():A.from("sale"),c.toBuffer()],P))[0],k=(await o.PublicKey.findProgramAddress([R?T.publicKey.toBuffer():A.from("fees"),c.toBuffer(),t.toBuffer()],P))[0],C=await (0,m.pf)(n),I=await g.Metadata.fromAccountAddress(e,C);if(!I)throw Error("No metadata found for "+n);let B=o.SystemProgram.createAccount({programId:f.H_,space:165,lamports:await e.getMinimumBalanceForRentExemption(165,"singleGossip"),fromPubkey:t,newAccountPubkey:T.publicKey}),E=(0,w.createInitializeAccountInstruction)(T.publicKey,c,t),L=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:v,isSigner:!1,isWritable:!0},{pubkey:T.publicKey,isSigner:!1,isWritable:!0},{pubkey:x,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:N,isSigner:!1,isWritable:!0},{pubkey:k,isSigner:!1,isWritable:!0},{pubkey:C,isSigner:!1,isWritable:!0},{pubkey:o.SYSVAR_RENT_PUBKEY,isSigner:!1,isWritable:!1},{pubkey:o.SystemProgram.programId,isSigner:!1,isWritable:!1},{pubkey:f.H_,isSigner:!1,isWritable:!1}],K=new o.TransactionInstruction({programId:P,keys:L,data:A.from([4,...new d(1e9*i).toArray("le",8),...new d(s).toArray("le",8),...new d(l).toArray("le",8)])}),M=(null===(u=I.programmableConfig)||void 0===u?void 0:u.ruleSet)||o.PublicKey.default,q=(0,y.findTokenRecordPDA)(c,N),F=(0,y.findTokenRecordPDA)(c,T.publicKey),G=!M.equals(o.PublicKey.default),U=await o.PublicKey.findProgramAddress([A.from("escrow")],P);return G&&L.push({pubkey:U[0],isSigner:!1,isWritable:!0}),G&&L.push({pubkey:(0,y.getNFTEdition)(c),isSigner:!1,isWritable:!0}),G&&L.push({pubkey:b,isSigner:!1,isWritable:!1}),G&&L.push({pubkey:S,isSigner:!1,isWritable:!1}),G&&L.push({pubkey:o.SYSVAR_INSTRUCTIONS_PUBKEY,isSigner:!1,isWritable:!1}),G&&L.push({pubkey:q,isSigner:!1,isWritable:!0}),G&&L.push({pubkey:F,isSigner:!1,isWritable:!0}),G&&L.push({pubkey:h,isSigner:!1,isWritable:!1}),G&&L.push({pubkey:M,isSigner:!1,isWritable:!1}),{instructions:[B,E,K],escrowAccount:T}}var R=a(18473),T=a(18407),N=a(73278),x=a(12012),k=a(310),C=a(29750),I=a(77191),B=a.n(I),E=a(33942),L=a(48764).Buffer;let additionalComputeUnitInstruction=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:35e5;return o.ComputeBudgetProgram.setComputeUnitPrice({microLamports:e})},addComputeUnits=e=>o.ComputeBudgetProgram.setComputeUnitLimit({units:e});var useRain_hook=()=>{let e=(0,C.yG)(),{connection:t}=(0,n.R)(),{refresh:a}=(0,l.useContext)(r.default),{refreshBalance:c,balance:g}=(0,l.useContext)(s.default),{setTransactionState:w,transactionState:A}=(0,l.useContext)(u.default),[S,b]=(0,l.useState)(null);(0,l.useEffect)(()=>{(0,N.wF)("https://api.rain.fi/cnft").then(e=>b(e))},[]);let v=new d.Rain(S,e.publicKey),{getFeesDetailed:P,getMortgagesFeesDetailed:h,getAllPools:I,getLoansFromPool:K,getLoansFromBorrower:M,getAvailableCollections:q,getCustomLoanOffersFromBorrower:F,getCustomLoanOffersFromCollectionId:G,getCustomLoanOffersFromLender:U,computeAmount:W,getCollection:D,getMortgageFromAddress:_,getDebtsForSale:V,getDebtsSold:H,getMortgagesFromCollectionId:O}=v.utils,{poolCancelMortgageProposal:z,freeze:Y,makeMortgageRequest:Z,cancelMortgageRequest:j,acceptMortgageRequest:J,executeMortgageRequest:Q,configMortgage:X,updatePoolWhitelist:$,listNft:ee,delistNft:et}=v.instructions,{deserializePoolAccount:ea,deserializeCollectionAccount:en,deserializeLoanAccount:eo,deserializeLoanRequestAccount:ei}=v;async function onFullMortgageBuyApi(t){w({txid:"",name:"BNPL",status:u.TransactionState.PREPARING});let n=(0,T.B)(),o=await (0,x.D6)(e.publicKey,t,n),i=await signAndSendMultiplesApi(o,"BNPL");return a("loans"),a("assets"),i}async function onInstantSellApi(t,n,i){w({txid:"",name:"Instant Sell",status:u.TransactionState.PREPARING});let s=await (0,x.pR)(e.publicKey,new o.PublicKey(t.accountAddress),n,i),l=await signAndSendMultiplesApi(s,"Instant Sell");return a("loans"),a("assets"),l}async function onFullMortgageBuyRain(e,t){w({txid:"",name:"Buy loan",status:u.TransactionState.PREPARING});let n=await v.buyListedMortgage(e,t);var o=await signAndSendMultiples(n);return a("loans"),a("assets"),c(),o}async function onFreezeAsset(n,o,i){w({txid:"",name:"Freeze asset",status:u.TransactionState.PREPARING});let s=await Y(t,e.publicKey,n,o,i),l=await signAndSend(s,void 0,void 0,"Freeze asset");return a("loans"),a("assets"),c(),l}async function onSellMortgage(e,t,n){w({txid:"",name:"Sell loan",status:u.TransactionState.PREPARING});let o=await v.sellMortgage(e,t,n),i=await signAndSend([o],void 0,void 0,"Sell loan");return a("loans"),a("assets"),i}async function listNftForSale(n,o){w({txid:"",name:"List NFT",status:u.TransactionState.PREPARING});let i=await v.unfreeze(n),s=await ee(t,e.publicKey,n,o);s.instructions.shift();let l=await signAndSend([...i,...s.instructions],s.signer,void 0,"List NFT");return handleSendActivity(t,l),a("loans"),l}async function onClaimSale(n){w({txid:"",name:"Claim sale",status:u.TransactionState.PREPARING});let o=await (0,k.claimSale)(t,e.publicKey,n),i=await signAndSend(o,void 0,void 0,"Claim sale");return a("loans"),c(),i}async function delistNftForSale(n,o,i){w({txid:"",name:"Delist",status:u.TransactionState.PREPARING});let s=await et(t,e.publicKey,n),l=await Y(t,e.publicKey,n,o,i);l.shift();let r=await signAndSend([...s,...l],void 0,void 0,"Delist");return handleSendActivity(t,r),a("loans"),r}async function onLiquidateMortgage(e){let t=await v.liquidate(e),n=await signAndSend([t]);return a("loans"),a("assets"),n}async function onMakeMortgageRequest(n){w({txid:"",name:"Request",status:u.TransactionState.PREPARING});let o=await Z(t,e.publicKey,n),i=await signAndSend([o],void 0,void 0,"Request");return a("address-loan-request"),a("assets"),i}async function onCancelMortgageRequest(n){w({txid:"",name:"Cancel request",status:u.TransactionState.PREPARING});let o=await j(t,e.publicKey,n),i=await signAndSend([o],void 0,void 0,"Cancel request");return a("address-loan-request"),a("assets"),i}async function onAcceptMortgageRequest(n){w({txid:"",name:"Accept request",status:u.TransactionState.PREPARING});let o=await J(t,e.publicKey,n),i=await signAndSend([o],void 0,void 0,"Accept request");return a("pool-loan-request"),a("assets"),i}async function onPoolCancelMortgageProposal(n){w({txid:"",name:"Cancel request",status:u.TransactionState.PREPARING});let o=await z(t,e.publicKey,n),i=await signAndSend([o],void 0,void 0,"Cancel request");return a("pool-loan-request"),a("assets"),i}async function onExecuteMortgageRequest(n){w({txid:"",name:"Loan request",status:u.TransactionState.PREPARING});let o=await Q(t,e.publicKey,n),i=await Y(t,e.publicKey,o.signers.publicKey,n.nftMint,n.poolOwner);var s=await signAndSendMultiples([{ixs:o.instruction,signers:o.signers},{ixs:i,signers:null}]);return a("loans"),a("assets"),s}async function onCreatePool(e,t){w({txid:"",name:"Create pool",status:u.TransactionState.PREPARING});let n=(0,T.B)(),o=await v.createPool({...e,referrer:n},t),i=await signAndSend(o,void 0,void 0,"Create pool");return a("mypool"),a("pool"),c(),i}async function onCancelAndCreatePool(t,n,o){w({txid:"",name:"Create pool",status:u.TransactionState.PREPARING});let i=await (0,x.Hf)(e.publicKey),s=o?await v.addLiquidity(t.amount):await v.createPool(t,n),l={transaction:L.from((await signAndCreate(s)).tx.serialize()).toString("base64"),isVersioned:!0},r=await signAndSendMultiplesApi([...i,l],"Create pool");return a("mypool"),a("pool"),c(),r}async function onUpdatePool(t,n,o,i){w({txid:"",name:"Update pool",status:u.TransactionState.PREPARING});let s=(0,T.B)(),l=o&&await X(e.publicKey,o),r=await v.updatePoolCollections(t.collections),d=await v.updatePool({...t,referrer:s}),p=[];switch(n){case"pool":p.push(d);break;case"collections":p.push(r);break;default:p.push(...[r,d])}if(o&&p.push(l),i){let e=await getUpdatePoolWhitelistIxs(i.isEnabled,i.lookupTable,i.addresses);p.push(...e)}let f=await signAndSend(p,void 0,void 0,"Update pool");return a("mypool"),a("pool"),c(),f}async function getUpdatePoolWhitelistIxs(a,n,o){let i=[],s=a&&!n&&o.length>0,l=!a&&n,r=a&&n&&o.length>0;if(s){let a=await (0,f.oT)(t,e.publicKey,o),n=$(null==e?void 0:e.publicKey,a.address);i.push(...a.ixs,n)}else if(l){let t=(0,f.K1)(e.publicKey,n),a=$(null==e?void 0:e.publicKey,void 0);i.push(a,...t)}else if(r){let a=await t.getAddressLookupTable(n);if(a.value){let s=o.filter(e=>!a.value.state.addresses.find(t=>e.equals(t))),l=a.value.state.addresses.filter(e=>!o.find(t=>e.equals(t)));if(l.length>0){let a=(0,f.K1)(e.publicKey,n),s=await (0,f.oT)(t,e.publicKey,o),l=$(null==e?void 0:e.publicKey,s.address);i.push(...a,...s.ixs,l)}else if(s.length>0){let t=(0,f.pV)(e.publicKey,n,s);i.push(t)}}}return i}async function onUpdateCollections(e){w({txid:"",name:"Update pool",status:u.TransactionState.PREPARING});let t=await v.updatePoolCollections(e),n=await signAndSend([t],void 0,void 0,"Update pool");return a("mypool"),a("pool"),n}async function onUpdatePoolStatus(e,t,n){w({txid:"",name:"Update pool",status:u.TransactionState.PREPARING});let o=[];t&&o.push(...await v.addLiquidity(t)),n&&o.push(await v.updatePool(n)),o.push(v.updatePoolStatus(e));let i=await signAndSend(o,void 0,void 0,"Update pool");return a("mypool"),a("pool"),i}async function onClosePool(){w({txid:"",name:"Close pool",status:u.TransactionState.PREPARING});let e=await signAndSend([v.closePool(!0)],void 0,void 0,"Close pool");return a("mypool"),e}async function onWithdrawLiquidity(t,n){w({txid:"",name:"Withdraw",status:u.TransactionState.PREPARING});let i=await v.withdrawLiquidity(t),s=(0,f.w2)(n,e.publicKey);if(!n.equals(new o.PublicKey("So11111111111111111111111111111111111111112"))){let t=(0,E.j)(e.publicKey,s,e.publicKey,n);i.unshift(t)}let l=await signAndSend(i,void 0,void 0,"Withdraw");return c(),a("mypool"),l}async function onAddLiquidity(e){w({txid:"",name:"Add liquidity",status:u.TransactionState.PREPARING});let t=await v.addLiquidity(e),n=await signAndSend(t,void 0,void 0,"Add liquidity");return c(),a("mypool"),a("pool"),n}async function onBorrow(e,t){w({txid:"",name:"Borrow",status:u.TransactionState.PREPARING});let n=(0,T.B)();var{instruction:o,signers:i}=await v.borrow({...e,assetId:e.nftMint},n,t);let s=await signAndSend(o,i,void 0,"Borrow");return a("loans"),a("assets"),c(),s}async function onBorrowApi(t,n,o){w({txid:"",name:"Borrow",status:u.TransactionState.PREPARING});let i=(0,T.B)(),s="Rain"==o?await (0,x.xI)(e.publicKey,t,i,n):await (0,x.dy)(e.publicKey,t,o),l=await signAndSendMultiplesApi(s,"Borrow");return a("loans"),a("assets"),c(),l}async function onTakeDefiLoan(e){w({txid:"",name:"Borrow",status:u.TransactionState.PREPARING});let t=(0,T.B)(),n=await (0,x.f6)(e,null==t?void 0:t.toBase58()),o=await signAndSendMultiplesApi(n,"Borrow");return a("loans"),c(),o}async function onMarginSwap(e){w({txid:"",name:"Magic Swap",status:u.TransactionState.PREPARING});let t=(0,T.B)(),n=await (0,x.UZ)(e,null==t?void 0:t.toBase58()),o=await signAndSendMultiplesApi(n,"Magic Swap");return a("loans"),c(),o}async function onSellTokensCollateral(e){w({txid:"",name:"Instant Sell",status:u.TransactionState.PREPARING});let t=await (0,x.Di)(e),n=await signAndSendMultiplesApi(t,"Instant Sell");return a("loans"),c(),n}async function onBorrowNfts(t){w({txid:"",name:"Multiple borrow",status:u.TransactionState.PREPARING});let n=(0,T.B)(),o=await (0,x.Uf)(e.publicKey,t,n),i=await signAndSendMultiplesBorrowApi(o,"Multiple borrow");return a("loans"),a("assets"),c(),i}async function onExtendApi(t,n){w({txid:"",name:"Extend loan",status:u.TransactionState.PREPARING});let o=(0,T.B)(),i=await (0,x.sf)(e.publicKey,t,n,o),s=await signAndSendMultiplesApi(i,"Extend loan");return a("loans"),a("assets"),c(),s}async function onExtend(e,t){w({txid:"",name:"Extend loan",status:u.TransactionState.PREPARING});let{instruction:n,signers:i}=await v.extend(e,t),s=o.ComputeBudgetProgram.requestHeapFrame({bytes:262144});n.unshift(s);let l=await signAndSend(n,i,void 0,"Extend loan");return a("loans"),a("assets"),c(),l}async function onRepayLoan(t,n,o){w({txid:"",name:"Repay loan",status:u.TransactionState.PREPARING});let i=await v.repayLoan(t,n,(null==e?void 0:e.publicKey.toBase58())!="CpnSYt9Rx8YTYWwFPaKTLvkNvUYEVst1iwkHtRHPxFyv"&&o),s=await signAndSend(i,void 0,!0,"Repay loan");return a("loans"),a("assets"),c(),s}async function onRepayLoanApi(t,n){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"Rain";w({txid:"",name:"Repay loan",status:u.TransactionState.PREPARING});let i="Rain"==o?await (0,x.et)(e.publicKey,t,n):await (0,x.Vs)(e.publicKey,t,o),s=await signAndSendMultiplesApi(i,"Repay loan");return a("loans"),a("assets"),c(),s}async function onExtendExternalLoan(t,n,o){w({txid:"",name:"Extend loan",status:u.TransactionState.PREPARING});let i=(0,T.B)(),s=await (0,x.Vs)(e.publicKey,t.loan,n),l="Rain"==o?await (0,x.xI)(e.publicKey,t,i,!1):await (0,x.dy)(e.publicKey,t,o),r=await signAndSendMultiplesApi([...s,...l],"Extend loan");return a("loans"),c(),r}async function onRepayMultipleLoan(t){w({txid:"",name:"Multiple Repay",status:u.TransactionState.PREPARING});let n=t.filter(e=>!e.platform||"Rain"===e.platform),o=n.length?await (0,x.qO)(e.publicKey,n):[],i=await signAndSendMultiplesRepayApi(o,"Multiple repay");return a("loans"),a("assets"),c(),i}async function onMakeLoanRequest(n){w({txid:"",name:"Loan request",status:u.TransactionState.PREPARING});let i=await t.getAccountInfo((0,y.getWhitelistPda)(new o.PublicKey(n.nftMint))),s=(null==i?void 0:i.data)?null:await (0,x.Cy)(e.publicKey,n.nftMint),l=await v.makeLoanRequest({...n,collectionId:n.collectionId}),r=(await signAndCreate([l])).tx,d=[{transaction:L.from(r.serialize()).toString("base64"),isVersioned:!0}];s&&d.unshift(null==s?void 0:s.payload);let c=await signAndSendMultiplesApi(d,"Loan request");return a("address-loan-request"),a("assets"),c}async function onCancelLoanRequest(e){w({txid:"",name:"Cancel request",status:u.TransactionState.PREPARING});let t=await v.cancelLoanRequest(e),n=await signAndSend([t],void 0,void 0,"Cancel request");return a("address-loan-request"),a("assets"),n}async function onAcceptLoanRequest(e){w({txid:"",name:"Accept request",status:u.TransactionState.PREPARING});let t=await v.acceptLoanRequest(e),n=await signAndSend([t],void 0,void 0,"Accept request");return a("pool-loan-request"),a("assets"),n}async function onPoolCancelLoanProposal(e){w({txid:"",name:"Cancel request",status:u.TransactionState.PREPARING});let t=await v.poolCancelLoanProposal(e),n=await signAndSend([t],void 0,void 0,"Cancel request");return a("pool-loan-request"),a("assets"),n}async function onExecuteLoanRequest(e){w({txid:"",name:"Execute loan request",status:u.TransactionState.PREPARING});let t=await v.executeLoanRequest(e),n=await signAndSend(t.instruction,t.signers,void 0,"Execute loan request");return a("address-loan-request"),a("assets"),n}async function onLiquidateLoan(e){w({txid:"",name:"",status:u.TransactionState.PREPARING});let t=await v.liquidate(e),n=await signAndSend([t]);return a("loans"),a("assets"),n}async function setMaxAmountUsable(e){w({txid:"",name:"Update pool",status:u.TransactionState.PREPARING});let t=v.setMaxAmountUsable(e),a=await signAndSend([t],void 0,void 0,"Update pool");return a}async function listSolanart(a,n,o,i){w({txid:"",name:"List NFT",status:u.TransactionState.PREPARING});let s=await listV1(t,e.publicKey,a,n,o,i),l=await signAndSend(s.instructions,s.escrowAccount,void 0,"List NFT");return handleSendActivity(t,l),l}async function buySolanart(a,n){w({txid:"",name:0==n?"Delist NFT":"Buy NFT",status:u.TransactionState.PREPARING});let o=await (0,R.buyEscrow)(t,e.publicKey,a,n),i=await signAndSend(o.fullIx,void 0,void 0,0==n?"Delist NFT":"Buy NFT");return handleSendActivity(t,i),i}let signAndCreate=async function(a,n){arguments.length>2&&void 0!==arguments[2]&&arguments[2],arguments.length>3&&void 0!==arguments[3]&&arguments[3];let i=arguments.length>4?arguments[4]:void 0;if(g<.01)throw Error("You need at least 0.01 SOL to interact with the protocol.");let s=[];a.forEach(e=>e.keys.forEach(e=>{var t;return s.push((null===(t=e.pubkey)||void 0===t?void 0:t.toBase58())||"")})),new Set(s).size;let[l,r]=await Promise.all([getAddressLookupTableAccounts(t,[new o.PublicKey("FszP29ebAWrmKHtrL6ieS5Xu48d6TPk1RdFHFBXeST3G"),new o.PublicKey("ztFFV6nfS7veRm2BbQgwaLnsenBjEfs6fpQde6reaco")]),i?Promise.resolve(i):getBlockhash(t)]),u=new o.TransactionMessage({payerKey:e.publicKey,recentBlockhash:r.blockhash,instructions:[...a]}).compileToV0Message(l),d=new o.VersionedTransaction(u);n&&d.sign([n]);let c=await t.simulateTransaction(d);console.log(c.value.logs);let p=c.value.unitsConsumed,f=0,y=!c.value.err&&p?1.1*p:14e5,w=(0,m.Z4)();w&&p&&(f=await handleCustomNetworkFees(w,y,t.rpcEndpoint));let A=new o.TransactionMessage({payerKey:e.publicKey,recentBlockhash:r.blockhash,instructions:[additionalComputeUnitInstruction(Math.round(f)),addComputeUnits(y),...a.filter(e=>!e.programId.equals(o.ComputeBudgetProgram.programId))]}).compileToV0Message((null==l?void 0:l.length)?l:void 0),S=new o.VersionedTransaction(A);return n&&S.sign([n]),{tx:S,latestBlockhash:r}},signAndSend=async(t,a,n,o)=>{let{tx:i,latestBlockhash:s}=await signAndCreate(t,a,!1,n);w({txid:"",name:o,status:u.TransactionState.WAITING_FOR_SIGNATURE});let l=await e.signTransaction(i),r=B().encode(l.signatures[0]);w({txid:r,name:o,status:u.TransactionState.SENDING});let d=await (0,x.n_)(l);return console.log({signature:d}),w({txid:d,name:o,status:u.TransactionState.CONFIRMED}),c(),d},signAndSendMultiples=async a=>{let n=[],o=await getBlockhash(t),s=await Promise.all(a.map(async e=>await signAndCreate(e.ixs,e.signers,!0,!1,o)));w(e=>({txid:"",name:null==e?void 0:e.name,status:u.TransactionState.WAITING_FOR_SIGNATURE}));let l=await e.signAllTransactions(s.map(e=>e.tx)),r=B().encode(null==l?void 0:l[(null==l?void 0:l.length)-1].signatures[0]);w(e=>({txid:r,name:null==e?void 0:e.name,status:u.TransactionState.SENDING}));let d=chunkArray(l,10);for(let e=0;e<d.length;e++){i.notify.info({message:"Transactions ".concat(e+1,"/").concat(d.length," sent")});let a=await processChunk(t,d[e],10*e,l.length);n.push(...a)}return w(e=>({txid:n[0],name:null==e?void 0:e.name,status:u.TransactionState.CONFIRMED})),n},signAndSendMultiplesApi=async function(t){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Transaction",n=[],i=t.map(e=>o.VersionedTransaction.deserialize(L.from(e.transaction,"base64")));w({txid:"",name:a,status:u.TransactionState.WAITING_FOR_SIGNATURE});let s=await e.signAllTransactions(i),l=B().encode(null==s?void 0:s[(null==s?void 0:s.length)-1].signatures[0]);for(let[e,t]of(w({txid:l,name:a,status:u.TransactionState.SENDING}),s.entries())){let e=await (0,x.n_)(t);n.push(e)}return w({txid:l,name:a,status:u.TransactionState.CONFIRMED}),n},signAndSendMultiplesBorrowApi=async(a,n)=>{let i=[],s=[];for(let e of a){let t=e.map(e=>(e.isVersioned,o.VersionedTransaction.deserialize(L.from(e.transaction,"base64"))));s.push(...t)}w({txid:"",name:n,status:u.TransactionState.WAITING_FOR_SIGNATURE});let l=await e.signAllTransactions(s),r=B().encode(null==l?void 0:l[(null==l?void 0:l.length)-1].signatures[0]);w({txid:r,name:n,status:u.TransactionState.SENDING});let d=chunkArray(l,10);for(let e=0;e<d.length;e++){let a=await processChunk(t,d[e],10*e,l.length);i.push(...a)}return w({txid:r,name:n,status:u.TransactionState.CONFIRMED}),i},signAndSendMultiplesRepayApi=async(t,a)=>{let n=[],i=[];for(let e of t){let t=e.map(e=>(e.isVersioned,o.VersionedTransaction.deserialize(L.from(e.transaction,"base64"))));i.push(...t)}w({txid:"",name:a,status:u.TransactionState.WAITING_FOR_SIGNATURE});let s=await e.signAllTransactions(i),l=B().encode(null==s?void 0:s[(null==s?void 0:s.length)-1].signatures[0]);w({txid:l,name:a,status:u.TransactionState.SENDING});let r=await Promise.allSettled(s.map(async e=>{let t=await (0,x.n_)(e);return t}));return r.forEach(e=>{"fulfilled"===e.status&&n.push(e.value)}),w({txid:l,name:a,status:u.TransactionState.CONFIRMED}),n},handleCustomNetworkFees=async(e,t,a)=>{let n=Math.round((null==e?void 0:e.amount)*1e9);if((null==e?void 0:e.type)!=="maxCap")return n/1e-6/t;{let o=await (0,x.xD)(a)||35e4,i="turbo"===e.speed?10*o:"fast"===e.speed?5*o:o;return Math.min(i*t*1e-6,n)}};async function handleSendActivity(t,n){let o=i.notify.wait({message:"Updating items in wallet.."});t.onSignatureWithOptions(n,async t=>{if("status"===t.type)try{let{result:s}=t;if(!s.err){let t=await p().get("".concat("https://api-v2.solanart.io","/nfts/add_activity?txid=").concat(n,"&contract_id=solanart-v1"));Array.isArray(t.data)&&(i.notify.close(o),i.notify.success({message:"Done!"}),(null==e?void 0:e.publicKey)&&a("assets"))}}catch(t){i.notify.close(o),i.notify.success({message:"Done!"}),(null==e?void 0:e.publicKey)&&a("assets")}},{commitment:"confirmed"})}return{onCreatePool,onCancelAndCreatePool,onUpdatePool,onUpdateCollections,onUpdatePoolStatus,onClosePool,onWithdrawLiquidity,onAddLiquidity,onBorrow,onBorrowApi,onTakeDefiLoan,onBorrowNfts,onMarginSwap,onSellTokensCollateral,onClaimSale,onExtend,onExtendApi,onExtendExternalLoan,onRepayLoan,onRepayLoanApi,onRepayMultipleLoan,onLiquidateLoan,setMaxAmountUsable,onMakeLoanRequest,onCancelLoanRequest,onAcceptLoanRequest,onPoolCancelLoanProposal,onExecuteLoanRequest,getAllPools:I,getLoansFromPool:K,getLoansFromBorrower:M,getAvailableCollections:q,deserializePoolAccount:ea,deserializeCollectionAccount:en,deserializeLoanAccount:eo,deserializeLoanRequestAccount:ei,parseCollectionAccount:function(e,t){return{...en(e),collectionAddress:t.toString()}},getCustomLoanOffersFromBorrower:F,getCustomLoanOffersFromCollectionId:G,getCustomLoanOffersFromLender:U,handleErrorTx:function(e){let t,a="";for(let i=0;i<10;i++){var n,o;if(t=null==e?void 0:null===(n=e.message)||void 0===n?void 0:n.replace("failed to send transaction: Transaction simulation failed: Error processing Instruction ".concat(i,": custom program error: "),""),a=null===(o=v.errors.errorFromCode(parseInt(t)))||void 0===o?void 0:o.message)break}return a||"0x11"!==t||(a="NFT is frozen"),a&&"Not authorized"===a&&(a="\uD83D\uDCA7Rain.fi is currently under maintenance: Loans and mortgages have been paused. Repayments operate as usual."),a||"0x0"!==t||(a="A loan request already exist for that NFT, please choose another one"),a||null},getFeesDetailed:P,computeAmount:W,getCollection:D,poolHasCorrectByteSize:v.accounts.Pool.hasCorrectByteSize,loanHasCorrectByteSize:v.accounts.Loan.hasCorrectByteSize,listSolanart,buySolanart,listNftForSale,delistNftForSale,onFullMortgageBuyRain,onFullMortgageBuyApi,onFreezeAsset,onSellMortgage,onInstantSellApi,onLiquidateMortgage,getMortgageFromAddress:_,getDebtsForSale:V,getDebtsSold:H,getMortgagesFromCollectionId:O,onMakeMortgageRequest,onCancelMortgageRequest,onAcceptMortgageRequest,onPoolCancelMortgageProposal,onExecuteMortgageRequest,getMortgagesFeesDetailed:h}};let chunkArray=(e,t)=>{let a=[];for(let n=0;n<e.length;n+=t)a.push(e.slice(n,n+t));return a},processTx=async(e,t,a,n)=>{let o=await (0,x.n_)(t);return o},processChunk=async(e,t,a,n)=>{let o=[];for(let i=0;i<t.length;i++){let s=await processTx(e,t[i],a+i,n);o.push(s)}return o},getAddressLookupTableAccounts=async(e,t)=>{let a=await e.getMultipleAccountsInfo(t.map(e=>new o.PublicKey(e)));return a.reduce((e,a,n)=>{let i=t[n];if(a){let t=new o.AddressLookupTableAccount({key:new o.PublicKey(i),state:o.AddressLookupTableAccount.deserialize(a.data)});e.push(t)}return e},[])},getBlockhash=async e=>{let t;let a=0;for(;!t&&a<3;)t=await e.getLatestBlockhash("confirmed"),a++,t||await new Promise(e=>setTimeout(e,400));return t}},18407:function(e,t,a){"use strict";a.d(t,{B:function(){return getReferralAddress},I:function(){return signRainAuth}});var n=a(59917),o=a(77191),i=a.n(o),s=a(70955);let signRainAuth=async(e,t)=>{try{var a,n;if(!e.signMessage)throw Error("Wallet does not support signing messages. Ledger are not supported for now to update pool metadata.");if(!window.solana)return null;let t="Link your wallet with rain.fi in order to update your pool metadata",o=new TextEncoder().encode(t),l=(0,s.ej)("rain-fi-wallet-auth-".concat(null===(a=e.publicKey)||void 0===a?void 0:a.toBase58()));if((null==l?void 0:l.length)>0)return{signedMessage:l,message:t};let r=await e.signMessage(o);return(0,s.d8)("rain-fi-wallet-auth-".concat(null===(n=e.publicKey)||void 0===n?void 0:n.toBase58()),i().encode(r),{days:365}),{signedMessage:i().encode(r),message:t}}catch(e){return{error:e.message}}};function getReferralAddress(){let e=("; "+document.cookie).split("; referral=");if(2===e.length){let t=e.pop().split(";").shift();try{if("5931ggVZoYKxZ4YMGPqFEk5GoX9gdhfnq5Fd43b2U57C"==t){let e=new n.PublicKey("9C6whQ9BEjB6muCbQSsMd2q8agqeJ7MukbfTvu24MHBh");return e}let e=new n.PublicKey(t);return e}catch(e){return}}}},73278:function(e,t,a){"use strict";a.d(t,{wF:function(){return RpcWrappedConnection},z3:function(){return RpcConnection}});var n=a(10479),o=a(59917);a(9669),a(70955),a(96245);let RpcConnection=async(e,t)=>new o.Connection(e,{commitment:"processed",..."https://rpc.rain.fi"===e&&{}}),RpcWrappedConnection=async(e,t)=>new n.WrapperConnection(e,{commitment:"processed",...(null==e?void 0:e.startsWith("https://rpc.rain.fi"))&&{}})},56935:function(e,t,a){"use strict";a.d(t,{CH:function(){return getNFTfromMintANY},D8:function(){return addFloorPriceAndDelegate},Fl:function(){return fetchCompressedNFTS},H_:function(){return r},K1:function(){return deactivateAndDeleteLookupTable},W4:function(){return u},_Z:function(){return computeInterest},bt:function(){return getFeesDetailed},oT:function(){return createAndAddLookupTable},pV:function(){return extendLookupTable},w2:function(){return getAtaForMint}});var n=a(59917),o=a(26630),i=a(95827),s=a(9828);let l=new n.PublicKey("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"),r=new n.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA"),u=new n.PublicKey("So11111111111111111111111111111111111111112");function addFloorPriceAndDelegate(e,t){return e.map(e=>{let a=t.find(t=>t.url===e.collectionUrl);return a&&(e.floorPrice=a.floorPrice,e.mint=e.tokenAddress,e.collectionId=a.collectionId),e}).filter(e=>null==e?void 0:e.floorPrice).sort((e,t)=>e.floorPrice===1/0?1:isNaN(e.floorPrice)?-1:t.floorPrice-e.floorPrice)}let getAtaForMint=(e,t)=>n.PublicKey.findProgramAddressSync([t.toBuffer(),r.toBuffer(),e.toBuffer()],l)[0];async function createAndAddLookupTable(e,t,a){let o=n.AddressLookupTableProgram.createLookupTable({authority:t,payer:t,recentSlot:await e.getSlot()}),i=n.AddressLookupTableProgram.extendLookupTable({payer:t,authority:t,lookupTable:o[1],addresses:a});return{ixs:[o[0],i],address:o[1]}}function deactivateAndDeleteLookupTable(e,t){let a=n.AddressLookupTableProgram.deactivateLookupTable({lookupTable:t,authority:e});return n.AddressLookupTableProgram.closeLookupTable({lookupTable:t,authority:e,recipient:e}),[a]}function extendLookupTable(e,t,a){let o=n.AddressLookupTableProgram.extendLookupTable({payer:e,authority:e,lookupTable:t,addresses:a});return o}async function getNFTfromMintANY(e,t){try{let a=await (0,o.pf)(t),n=i.Metadata.fromAccountAddress(e,a),s=await (await axios.get(n.data.uri)).data;return{...s,...n,collectionId:9999}}catch(e){return null}}async function fetchCompressedNFTS(e,t){var a;let n=await (null==e?void 0:e.getAssetsByOwner({ownerAddress:t}));return null===(a=n.items)||void 0===a?void 0:a.filter(e=>e.compression.compressed&&["MONKE","TNSRNS"].includes(e.content.metadata.symbol)).map(e=>({id:0,url:"MONKE"===e.content.metadata.symbol?"saga_monkes":"tensorians",tokenAddress:e.id,mint:e.id,locked:!1,name:e.content.metadata.name,floorPrice:0,price:0,lastPrice:0,offer:0,image:e.content.links.image,animationUrl:"",attributes:[],isForSale:!1,sellerAddress:null,escrowAddress:null,auctionHouseAddress:null,contractId:null,marketplaceId:null,bidderAddress:null,hashAuction:null,updatedAt:null,createdAt:null,listedAt:null,collectionName:"MONKE"===e.content.metadata.symbol?"Saga Monkes":"Tensorians",collectionId:"MONKE"===e.content.metadata.symbol?1357:1038,collectionUrl:"MONKE"===e.content.metadata.symbol?"saga_monkes":"tensorians",isCompressed:!0}))}let computeInterest=function(e,t,a,n,o,i,l,r,u){let d=arguments.length>9&&void 0!==arguments[9]?arguments[9]:"loan",c=new s.BN(1e9),p=new s.BN(a).mul(c).div(new s.BN(100)),f=new s.BN(u).mul(c).div(new s.BN(100)),g=n.sub(o).sub(e),y=c.sub(g.mul(c).div(n)),m=p.add(y.mul(new s.BN(r)).div(new s.BN(100))),w=f.mul(new s.BN(t)).div(new s.BN(l)),A=c.clone(),S=c.clone(),b=w.mul(c);for(let e=1;e<=10;e++)S=S.mul(new s.BN(e)),A=A.add(b.div(S)),b=b.mul(w).div(c);let v=new s.BN(i).mul(c).div(new s.BN(100)),P=s.BN.max(v,m.mul(A).div(c)),h=P.mul(e).div(new s.BN(100)).div(c);return{interestLamports:h,interestPercentage:P,rainFees:h.mul(new s.BN("loan"==d?15:20)).div(new s.BN(100))}},getFeesDetailed=(e,t,a)=>{let n={feesInPercentage:0,feesInSol:0,rainFees:0,amountToLoan:0,duration:0};try{if(!(null==e?void 0:e.totalAmount)||!t||!a)return n;let{interestLamports:o,interestPercentage:i,rainFees:l}=computeInterest(new s.BN(Math.round(t)),a,e.loanCurve.interestRate,new s.BN(e.totalAmount),new s.BN(e.borrowedAmount),e.loanCurve.baseInterest,e.loanCurve.maxDuration/86400,e.loanCurve.curveRate,e.loanCurve.curveRateDay);return{feesInPercentage:(null==i?void 0:i.toNumber())/1e9,feesInSol:null==o?void 0:o.toNumber(),rainFees:null==l?void 0:l.toNumber(),amountToLoan:Math.floor(t),duration:a}}catch(e){return n}}},17343:function(){},60973:function(){},4757:function(){}}]);